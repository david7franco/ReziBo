<!-- chat.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Chatroom</title>
    <!-- Include jQuery for AJAX functionality -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Set up AJAX to include CSRF Token -->
    <script>
        // This will be called before every AJAX request
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!this.crossDomain) {
                    // Add CSRF token to the header for protection against CSRF
                    xhr.setRequestHeader("X-CSRFToken", $('input[name=csrfmiddlewaretoken]').val());
                }
            }
        });
    </script>
</head>
<body>
    <div id="chat-box" style="height: 300px; overflow-y: scroll; border: 1px solid #000;">
        <!-- Messages will be displayed here -->
    </div>

    <!-- Message form -->
    <form id="message-form">
        {% csrf_token %} <!-- Django template tag to include CSRF token -->
        <input type="text" id="message-input" placeholder="Type a message..." required>
        <button type="submit">Send</button>
    </form>

    <script>
        // Function to fetch messages from the server
        function fetchMessages() {
            $.ajax({
                url: '/chat/{{ Open_Ticekt }}/messages/',  // URL to the view that returns messages
                method: 'GET',
                success: function(data) {
                    $('#chat-box').empty();  // Clear the chat box
                    data.forEach(function(message) {
                        // Append each message to the chat box
                        $('#chat-box').append(
                            $('<div>').text(message.author + ': ' + message.text)
                        );
                    });
                }
            });
        }

        // Poll for new messages every 2 seconds
        setInterval(fetchMessages, 2000);

        // Handle the form submission to send a new message
        $('#message-form').submit(function(e) {
            e.preventDefault();
            var messageInput = $('#message-input');
            var messageText = messageInput.val();
            if (!messageText) {
                return;  // Don't send empty messages
            }

            // Send the message to the server
            $.ajax({
                url: '/chat/{{ Open_Ticket }}/send/',  // URL to the view that handles sending messages
                method: 'POST',
                data: {
                    'text': messageText  // 'csrfmiddlewaretoken' is added by $.ajaxSetup
                },
                success: function(data) {
                    messageInput.val('');  // Clear the input field
                    fetchMessages();  // Fetch messages to update the chat box immediately
                }
            });
        });
    </script>
</body>
</html>
